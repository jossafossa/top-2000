class t{constructor(t={}){this.events={}}on(t,e){this.events[t],this.events[t]=[],this.events[t].push(e)}emit(t,e){if(t in this.events)for(let s of this.events[t])s(e)}}class e{constructor(){this.controller=new AbortController}async get(t,e=!1,s=!1,i=!1){let r={signal:i.signal};e&&(r.body=JSON.stringify(e)),s&&(r.headers=s);let n=await fetch(t,r);return await n.json()}async getSong(t,e){return await this.get(`https://api.spotify.com/v1/search?q=track:${t}, artist:${e}&type=track`)}}class s extends t{getElement(t){var e=document.createElement("div");return e.innerHTML=t.trim(),e.children.length>1?e.children:e.firstChild}getItem(t){let{position:e,title:s,artist:i,change:r,changeLabel:n,image:o,new:a}=t,l=r<0?"is-negative":"is-positive";l=0===r?"is-neutral":l;let h=`\n\t\t<li data-id="${e}">\n\t\t\t\n\t\t\t<article class='list-entry'>\n\t\t\t\n\t\t\t\t<span>\n\t\t\t\t\t<strong>\n\t\t\t\t\t\t${e}\n\t\t\t\t\t</strong>\n\t\t\t\t</span>\n\t\t\t\t\n\t\t\t\t<header>\n\t\t\t\t\t\n\t\t\t\t\t<picture data-play>\n\t\t\t\t\t\t<img src='${o}' loading="lazy">\n\t\t\t\t\t</picture>\n\t\t\t\t\t\n\t\t\t\t</header>\n\t\t\t\t\n\t\t\t\t<section>\n\t\t\t\t\n\t\t\t\t\t<h2>\n\t\t\t\t\t\t${s}\n\t\t\t\t\t</h2>\n\t\t\t\t\t\n\t\t\t\t\t<h3>\n\t\t\t\t\t\t${i}\n\t\t\t\t\t</h3>\n\t\t\t\t\t\n\t\t\t\t</section>\n\t\t\t\t\n\t\t\t\t<footer>\n\t\t\t\t\t${a?'<span class="label">Nieuw</span>':""}\n\t\t\t\t\n\t\t\t\t\t<span class="label ${l}" data-change="${r}" >\n\t\t\t\t\t\t${n}\n\t\t\t\t\t</span>\n\t\t\t\t</footer>\n\t\t\t\t\n\t\t\t</article>\n\t\t</li>\n\t\t`,c=this.getElement(h);return this.setupItemEvents(c),c}setupItemEvents(){}getItems(t){let e=t.map((t=>this.getItem(t)));return console.log(e),e}getList(t){return this.getItems(t)}getSorter(t){let{name:e,label:s}=t;return`\n\t\t\t<button class='sorter' data-sort='${e}'>\n\t\t\t\t${s}\n\t\t\t\t<i class='asc fa fa-caret-up'></i>\n\t\t\t\t<i class='desc fa fa-caret-down'></i>\n\t\t\t\t<i class='icon fa fa-sort'></i>\n\t\t\t</button>\n\t\t`}getSorters(t){return t.map((t=>this.getSorter(t)))}getFilters(t){return this.getElement(`\n\t\t\t<div class='sorters'>\n\t\t\t\t<span>Sorteer: </span>\n\t\t\t\t${this.getSorters(t.sort).join("")}\n\t\t\t</div>\n\t\t`)}getYearSelector(t,e){let s=Object.keys(t);return s=s.map((t=>`<option value='${t}' ${e==t?"selected":""}>${t}</option> `)),this.getElement(`\n\t\t\t<select data-year>\n\t\t\t\t${s.join("")}\n\t\t\t</select>\n\t\t`)}}class i{find(t,e){let s=t;for(const i of e){if(!s||!s[i])return!1;s=s[i]}return s}sortBy(t,e,s=!0){return s=s?1:-1,(t=[...t]).sort(((t,i)=>this.find(t,e)>this.find(i,e)?-1*s:1*s)),t}}class r{downSizeImage(t){let e=t.split("/");return e=e.map((t=>t.startsWith("w_")?"w_100,h_100":t)),e.join("/")}sanitizeItem(t,e){var s;let{position:i,track:r}=e,n=i.previous>0?i.previous:2e3,o=n-i.current,a=o>0?`+${o}`:o;a=0===o?"â€”":a;let l=0===i.previous;return{id:e.id,time:e.broadcastUnixTime,position:i.current,previousPosition:n,new:l,change:o,changeLabel:a,artist:r.artist,title:r.title,image:this.downSizeImage(null!=(s=r.coverUrl)?s:"https://www.nporadio2.nl/images/unknown_track_m.webp")}}sanitizeList(t,e){return e.map((e=>this.sanitizeItem(t,e)))}sanitize(t){return Object.fromEntries(Object.entries(t).map((([t,e])=>[t=parseInt(t),this.sanitizeList(t,e)])))}}class n{sortBy(t,e=[]){return t.sort(((t,s)=>{for(let i of e){let e;Array.isArray(i)||(i=[i]);let r=i.map((t=>Array.isArray(t)));if(r=r.includes(!0),r)for(let n of i)e=s[n].length-t[n].length;else{let r=[],n=[];for(let e of i)r.push(t[e]),n.push(s[e]);r=r.join(" - "),n=n.join(" - "),e=r>n?-1:1}if(0!==e)return e}})),t}groupBy(t,e){e=(null==e?void 0:e.length)?e:[e];let s=[];for(let i of t){let t=[];for(let s of e)t.push(i[s]||"other");let r=t.join(" - ");s[r]=(null==s?void 0:s[r])||[],s[r].push(i)}return s=Object.entries(s).map((([t,e])=>({key:t,entries:e,count:e.length}))),s}getAveragePosition(t){return t.reduce(((t,e)=>t+e.position),0)/t.length}getList(t){let e=this.groupBy(t,"artist");for(let s of e)s.averagePosition=this.getAveragePosition(s.entries);return this.sortBy(e,["entries","key"]),{groupedByArtist:e}}getSong(t){return{test:"asdasd",averagePosition:t.reduce(((t,e)=>t+e.position),0)/t.length}}getSongs(t){let e=this.groupBy(t,["artist","title"]);e=this.sortBy(e,["entries","key"]);for(let s of e){let t=this.getSong(s.entries);for(let[e,i]of Object.entries(t))s[e]=i}return e}getAll(t){console.log(t);let e=[...Object.values(t).flat()],s={};for(let[i,r]of Object.entries(t))s[i]=this.getList(r);return{years:s,songs:this.getSongs(e)}}}class o extends t{constructor(t){super(),this.switchers=t.querySelectorAll("[data-year]");for(let e of this.switchers)e.addEventListener("change",(t=>this.switch(e)))}switch(t){let e=t.value;this.emit("switch",e)}}class a extends t{constructor(t){super(),this.sorters=t.querySelectorAll("[data-sort]");for(let e of this.sorters)e.addEventListener("click",(t=>this.sort(e)))}resetSort(){for(let t of this.sorters)t.sorted=!1,t.classList.remove("is-sorted"),t.classList.remove("is-asc")}sort(t){var e;let{sort:s}=t.dataset;this.lastSort!==s&&this.resetSort(),t.classList.add("is-sorted");let i=null!=(e=t.sorted)&&e;t.sorted=!i,t.classList[i?"add":"remove"]("is-asc"),this.emit("sort",{sort:s,asc:i}),this.lastSort=s}}class l{constructor(t,l){this.root=t,this.renderer=new s,this.sorter=new i,this.sanitizer=new r,this.statistics=new n,this.spotify=new e,this.filters={sort:[{name:"title",label:"title"},{name:"position",label:"position"},{name:"artist",label:"artist"},{name:"change",label:"change"}]},this.lists=this.sanitizer.sanitize(l),this.sortType=!1,this.sortOrder=!1,this.activeList=Object.keys(this.lists).sort().at(-1),this.statistics.getAll(this.lists),console.log(this.activeList),this.renderBase(t),this.renderList(this.activeList,this.getList());let h=this.renderYearSelection(this.lists,this.activeList),c=this.renderFilters(this.filters);this.sortListener=new a(c),this.sortListener.on("sort",(({sort:t,asc:e})=>{this.sortType=t,this.sortOrder=e,this.renderList(this.activeList)})),this.listSwitcher=new o(h),this.listSwitcher.on("switch",(t=>{this.activeList=t,this.renderList(this.activeList,this.getList())})),this.renderer.on("song-click",(t=>{let{artist:e,track:s}=t;this.Spotify.getSong(e,s)}))}getList(t=!1){return t=t||this.activeList,this.lists[t]}renderBase(t){this.filterRoot=document.createElement("header"),this.listWrapper=document.createElement("section"),this.listRoot=document.createElement("ul"),this.listRoot.classList.add("list"),this.listWrapper.append(this.listRoot),t.append(this.filterRoot,this.listWrapper)}renderList(t,e=!1){if(!1===e&&(e=this.getList()),this.sortType&&(e=this.sorter.sortBy(e,[this.sortType],this.sortOrder)),t===this.renderedList){let t=e.map((t=>t.position));return this.reorderListCSS(this.listRoot,t),this.listRoot}let s=this.renderer.getList(e);return this.setupEvents(s,e),this.listRoot.append(...s),this.renderedList=t,this.listRoot}async play(t){let e=await this.spotify.getSong(t.artist,t.track);console.log(e)}setupEvents(t,e){for(let s in t){let i=e[s];t[s].querySelector("[data-play]").addEventListener("click",(t=>this.play(i)))}}reorderListCSS(t,e){let s=[...t.children];for(let i of s){let t=parseInt(i.dataset.id),s=e.indexOf(t);i.style.order=s}}reorderListHTML(t,e){let s=[...t.children];s.sort(((t,s)=>{const i=parseInt(t.dataset.id),r=parseInt(s.dataset.id);return e.indexOf(i)-e.indexOf(r)})),s.forEach((e=>{t.appendChild(e)}))}renderFilters(t){let e=this.renderer.getFilters(t);return this.filterRoot.append(e),this.filterRoot}renderYearSelection(t,e){let s=this.renderer.getYearSelector(t,e);return this.filterRoot.append(s),this.filterRoot}}let h={2023:"https://www.nporadio2.nl/api/charts/top-2000-van-2023-12-25",2022:"https://www.nporadio2.nl/api/charts/top-2000-van-2022-12-25",2021:"https://www.nporadio2.nl/api/charts/top-2000-van-2021-12-25"};const c=async t=>{let e=await Promise.all(Object.entries(t).map((async([t,e])=>{let s=await(async t=>{let e,s=await fetch(t);try{e=s.json()}catch(i){e=!1}return e})(e);return void 0!==(null==s?void 0:s.positions)&&[t,s.positions]})));return e=e.filter((t=>!1!==t)),e=Object.fromEntries(e),e};(async()=>{let t=await c(h),e=document.querySelector(".root");new l(e,t),document.body.classList.add("loaded")})();
